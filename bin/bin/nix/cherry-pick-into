#!/usr/bin/env bash

# TODOs
# - trap premature exit and end on $current_branch
# - prevent fcs from opening in a non-git repo

_error() {
    echo "Error: $1"
    exit ${2:-1}
}

# uncomment the below line for dbeug mode
# debug=echo

# verify we are inside a git repo
[[ -z $(git rev-parse --is-inside-work-tree 2>/dev/null) ]] && _error "not inside a git repo" 2

current_branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')
target_branch=master

while true; do
    case $1 in
        pp) # push the current branch as well as target branch
            push_current_branch=1
            push_target_branch=1;
            shift ;;
        p) # push the target branch only
            push_target_branch=1;
            shift ;;
        *) break ;;
    esac
done

sha=$1
shift

if [[ $# -ne 0 ]]; then
    target_branch=$1
    shift
fi

${debug} git checkout $target_branch
${debug} git cherry-pick $sha
[[ -n $push_target_branch ]] && ${debug} git push origin $target_branch
${debug} git checkout $current_branch
[[ -n $push_current_branch ]] && ${debug} git push origin $current_branch
