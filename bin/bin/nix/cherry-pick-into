#!/usr/bin/env zsh
source $HOME/dotfiles/fzf/.fzfrc

# TODOs
# - trap premature exit and end on $current_branch
# - fail at any point in the git workflow if a non-standard exit occurs

# verify we are inside a git repo
[[ -z $(git rev-parse --is-inside-work-tree 2>/dev/null) ]] && _error "not inside a git repo" 2

declare -r current_branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')
target_branch=master
sha=$(git log --pretty=oneline | head -n1 | awk '{print $1}')

_error() {
    echo "Error: $1"
    exit ${2:-1}
}

_help() {
    cat <<EOF
$0: [h|d] [p|pp] <b> <s>

  h   | help
  d   | debug

  b   | branch             select target branch
  s   | sha                select target sha

  p   |                    push target
  pp  |                    push target and current
EOF
    exit
}

_finish() {
    git checkout $current_branch &>/dev/null
}
trap _finish EXIT

while true; do
    case $1 in
        h|help)   _help ;;
        s|sha)    sha=$(fcs) ;;
        b|branch) target_branch=$(fbr) ;;
        d|debug)  debug=echo ;;
        pp)       push_current_branch=1
                  push_target_branch=1 ;;
        p)        push_target_branch=1 ;;
        *)        break ;;
    esac
    shift
done

${debug} git checkout $target_branch || _error "checkout of $target_branch failed"
${debug} git cherry-pick $sha || _error "cherry-pick of $sha failed"
[[ -n $push_target_branch ]] && ${debug} git push origin $target_branch || _error "push of $target_branch failed"
${debug} git checkout $current_branch || _error "checkout of $current_branch failed"
[[ -n $push_current_branch ]] && ${debug} git push origin $current_branch || _error "push of $current_branch failed"
