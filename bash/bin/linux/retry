#!/usr/bin/env bash
#
## @file
## @author Eric Crosson <esc@ericcrosson.com>
## @brief Retry a command until it succeeds
## success.
## command's execution.
## @copyright WTFPLv2
## @version 1.0
#
#########
# License:
#
#             DO WHAT THE FUCK YOU WANT TO PUBLIC LICENSE
#                    Version 2, December 2004
#
# Copyright (C) 2015 Eric Crosson
#
# Everyone is permitted to copy and distribute verbatim or modified
# copies of this license document, and changing it is allowed as long
# as the name is changed.
#
#            DO WHAT THE FUCK YOU WANT TO PUBLIC LICENSE
#   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
#
#  0. You just DO WHAT THE FUCK YOU WANT TO.
#
#########
#
## @details
## @par Script abstract
##
## This script attempts to execute a command n times or until its exit
## code indicates success.
##
## @par Usage
##
## retry [-h] [-n retry_attempts] command
##
##   h : print this help menu
##   n : maximum number of times to invoke command
##
## @note Special thanks to [this StackExchange
## post](http://unix.stackexchange.com/a/82615), which provided the
## initial kernel of this script.
#
## @addtogroup bin Misellaneous utilities

## @var HELP_RETRY
## @brief Contains script invocation information
## @details Contains script invocation information and abstract.
## @ingroup bin
declare HELP_RETRY
HELP_RETRY=$(cat <<'EOF'
retry [-h] [-s <seconds_delay_between_attempts>] [-n retry_attempts] command

   -h|--help    : print this help menu
   -s|--delay   : seconds to sleep between consecutive attempts.
                    -s with no arguments sleeps for 1 second;
                    -s with arguments must omit the space between -s and its arg
   -n|--max     : maximum number of times to invoke command

Note: if -n|--max is not specified, retry will attempt $(command) 10 times.

EOF
)

## @var retry_maximum_attempts
## @brief Maximum number of times to attempt $(command)
## @ingroup bin
declare -i retry_maximum_attempts=10

## @var retry_seconds_delay
## @brief Number of seconds to wait between attempts of $(command)
## @ingroup bin
declare -i retry_seconds_delay=0

# Execute getopt
ARGS=$(getopt -o hn:s:: -l "help,max:,delay::" -n "$0" -- "$@");

# Fail on bad arguments
if [ $? -ne 0 ]; then
    exit 1
fi

eval set -- "${ARGS}";

# Obey command line arguments
while true; do
    case "${1}" in

	-h|--help)
	    echo -e "${HELP_RETRY}"
	    exit
	    ;;

	-s|--delay)
            case "$2" in
                "") retry_seconds_delay=1 ;;
                *)  retry_seconds_delay="$2"
		    shift
		    ;;
            esac
	    ;;

	-n|--max)
	    retry_maximum_attempts="$2"
	    shift
	    ;;

	--)
	    shift
	    break ;;
    esac
    shift
done

## @fn retry
## @brief Retry a command up to $1 times
## @details Retry a command $1 times or until its exit code indicates
## success
## @param $* Command to execute and possibly retry
retry() {
    local attempts=0
    until [[ $attempts -ge $retry_maximum_attempts ]]; do
        "$@" && break || {
                ((attempts++))
                if [[ $attempts -lt $retry_maximum_attempts ]]; then
		    sleep ${retry_seconds_delay}
		fi
            }
    done
}

retry "$@"
